---
layout: post
title: CVE-2021-37975 itw bug in v8 ephemeron processing
date: 2022-01-26 08:30
summary: CVE-2021-37975
meta_robots: noindex, nofollow
---

[https://securitylab.github.com/research/in_the_wild_chrome_cve_2021_37975/](https://securitylab.github.com/research/in_the_wild_chrome_cve_2021_37975/)

## test env.

9.4.146.22에서 패치됨

[CVE-2021-37977](https://bugs.chromium.org/p/chromium/issues/detail?id=1252878)과 같이 겸해서 볼까 생각중, 이건 9.4.146.18에서 패치

30603 테스트하던 9.4.146.14에서 테스트 예정, 9.4.146.22를 비교 대상으로.

## 분석 전략

issue 페이지는 공개되어 있지 않으므로 commit 메시지 및 패치 내역(diff)을 일단 훑어만 보자. 그리고 mym님 글 정독.

## ephemeron?

ephemeron(=ephemera) 사전적 의미: 수명이 아주 짧은 것, 잠깐 쓰고 버리는 것

[from wikipedia](https://en.wikipedia.org/wiki/Ephemeron): GC에서 두 가지 문제를 해결하기 위한 자료구조. 하나는 어떤 객체가 이제 막 수집될 것인지 알려줌. 다른 하나는 레퍼런스를 만들지 않고도 어떤 데이터가 어떤 객체와 연관이 있으며 이로 인해 gc로부터 수집되는 것을 방지하도록 하는 역할.

ephemeron이 뭔지 궁금해서 찾다가 논문까지 와버렸음.

[Ephemerons: A New Finalization Mechanism, Barry Hayes](https://static.aminer.org/pdf/PDF/000/522/273/ephemerons_a_new_finalization_mechanism.pdf), 90년대 논문

weak pairs를 수정하여 만든 것이고 두 가지 문제를 해결하기 위함. 첫 번째 문제는 a problem case where objects needing finalization are being inappropriately retained by pointers contained in information needed for their own finalization. 두 번째 문제는 independent of resurrection(?).

"almost collectable"에 대한 명확한 정의가 기술되어있지 않고 잠깐 따로 검색해봐도 잘 모르겠다. property table, weak pair 등의 용어가 나오는데 이것들을 명확히 이해하지 않고는 논문을 제대로 이해하기 힘들 것 같다.



[https://www.gnu.org/software/mit-scheme/documentation/stable/mit-scheme-ref/Weak-References.html](https://www.gnu.org/software/mit-scheme/documentation/stable/mit-scheme-ref/Weak-References.html)

Weak references: gc로부터 보호해주지 않는 reference를 의미. car, cdr이라는 용어가 나오는데 이것은 lisp같은 언어에서 나온듯... ([ref](https://medium.com/@aleksandrasays/my-other-car-is-a-cdr-3058e6743c15)) 

Weak pair: car: pointer(weakly), cdr: pointer(strongly). car와 cdr은 같은 것을 반드시 가르키는 것은 아님. 

ephemeron: an object with two weakly referenced components called its "key" and "datum". key에 대해 아무도 신경쓰지 않을 경우(strong ref가 없을 경우를 의미하는듯?) ephemeronon은 broken. 특히, datum이 ephemeron의 key를 가리키는 것은 broken을 막지 못함(이것은 weak pair와 가장 큰 차이점인듯). 


## patch commit

commit message: fixpoint(fixedpoint?) 도달을 위한 iteration 알고리즘(마킹을 위한 것이겠지...?)이 너무 오래 걸릴 경우 이를 중단하고 linear algorithm을 수행하도록 코드 refactoring.   
CHECK 구문 추가, local ephemerons를 global로 flush 하는 구분 추가.   
force another iteration when ProcessMarkingWorklist() processed some object --> 
요게 취약점과 관련된 부분이 아닐까 예상해봄. 패치 코드를 보면 object_processed>0 을 확인하여 iteration을 한 번 더 돌게 하는 구문이 추가되었음.  
VERIFY_HEAP 플래그 존재시 이를 검증하는 구문 추가.

## mym 포스팅 읽고 이해

### The garbage collector in v8

v8은 mark-and-sweep gc. "visit"이 실제로 의미하는 바는 [Visit*](https://source.chromium.org/chromium/chromium/src/+/c7e42efb60d0e5768bdb096e7979d77333d32423:v8/src/heap/marking-visitor.h;l=122) 함수를 호출하는 것을 의미함.

grey: objects got pushed onto the worklist

black: processed objects

white: not (yet) reachable

---

v8 gc: a generational gc(old space & new space for small objects, large object space for 1 << 17 bytes - where is it defined?)
```cpp
// cppgc/globals.h
...
constexpr size_t kPageSizeLog2 = 17;
constexpr size_t kPageSize = 1 << kPageSizeLog2;
...
constexpr size_t kLargeObjectSizeThreshold = kPageSize / 2;
...
```

kLargeObjectSizeThreshold가 기준이 되는 것일수도. 필요할 경우 추후에 더 찾아보자.

---

minor gc(Scavenger), major gc(Full Mark-Compact, implemented in heap/mark-compact.cc) ([ref](https://v8.dev/blog/trash-talk))

concurrent marking: implemendted in heap/concurrent-marking.cc

main differences: concurrent marking은 몇 번의 iteration만 수행, mark-compact는 더이상 reachable objects가 발견되지 않을때까지 수행. **중요!!** concurrent marking은 uncertainty를 만들고 이를 추후에 uaf triggering시 이용할 것임

궁금점: concurrent marking은 minor gc 혹은 major gc와는 전혀 별개인 것인지? 개념, 관계가 잘 안잡히는데...  
- [ref](https://v8.dev/blog/trash-talk#scavenging)에 따르면 Scavenging은 parallel하게, major GC(mark and compact)는 concurrent하게 marking 이라고 함... (2019년 자료 기준)

궁금점2: heap 경로 밑에 gc 관련 코드들이 많은데, heap/cppgc/ 밑에도 또한 많이 있음(이것들은 oilpan library 관련인 것으로 암). 정확한 관계, 내용 등이 궁금한데... 일단 oilpan cppgc 쪽을 공부하고 와야하나.

... 공부하러 가보자. [ref1](https://v8.dev/blog/high-performance-cpp-gc) [ref2](https://v8.dev/blog/oilpan-library)  
이건 별도 문서로.

------------------------

ㅁㄴㅇㄹ



